# Chapter 12: Shared Memory Virtual Filesystem

* Sharing a region of memory backed by a file or device is simply a case of
  calling [mmap()][mmap] with the `MAP_SHARED` flag.

* Regardless, there are 2 important cases where an _anonymous_ region needs to
  be shared between processes:

1. When an `mmap()` with `MAP_SHARED` is used without file backing - these
   regions will be shared between a parent and a child process after a
   [fork()][fork] is executed.

2. A region explicitly sets up an anonymous mapping via (userland calls)
   [shmget()][shmget] and attaches to the virtual address space with
   [shmat()][shmat].

* When pages within a VMA are backed by a file on disk, the interface used is
  fairly straightforward. To read a page during a page fault, the required
  `nopage()` function is found in the
  [struct vm_area_struct][vm_area_struct]`->vm_ops` field and the required
  `writepage()` function is found in the
  [struct address_space_operations][address_space_operations] using
  `inode->i_mapping->a_ops` or alternatively `page->mapping->a_ops`.

* When normal file operations are taking place such as `mmap()`, [read()][read]
  and [write()][write], the [struct file_operations][file_operations] with the
  appropriate functions is found using `inode->i_fop`. The diagram shown in 4.2
  goes into more detail.

* The interface is nice and clean and is conceptually easy to understand, but it
  does not help _anonymous_ pages as there is no file backing there.

* To keep this nice interface, linux creates an artificial file backing for
  anonymous pages using a RAM-based filesystem where each VMA is backed by a
  file in this filesystem.

* Every inode in the artificial filesystem is placed on a linked list,
  [shmem_inodes][shmem_inodes], so they can be easily located.

* Overall this approach allows the same file-based interface to be used without
  treating anonymous pages as a special case.

* The filesystem comes in two variations in 2.4.22 - `shm` and `tmpfs`. They
  share core functionality and mainly different in what they're used for - `shm`
  is used by the kernel for creating file backings for anonymous pages and for
  backing regions created by [shmget()][shmget], the filesystem is mounted by
  [kern_mount()][kern_mount] so it's mounted internally and isn't visible to
  users.

* `tmpfs` is a temporary file system that is often mounted at `/tmp` publicly as
  as fast RAM-based temp fs. A secondary use for tmpfs is to mount `/tmp/shm`
  which allows [mmap()][mmap]-ing of files there in order to share information
  as a form of [IPC][ipc]. Regardless of the type of use, a sysadmin has to
  explicitly mount the tmpfs.

[mmap]:http://man7.org/linux/man-pages/man2/mmap.2.html
[fork]:http://man7.org/linux/man-pages/man2/fork.2.html
[shmget]:http://man7.org/linux/man-pages/man2/shmget.2.html
[shmat]:http://man7.org/linux/man-pages/man2/shmat.2.html
[vm_area_struct]:https://github.com/lorenzo-stoakes/linux-historical/blob/v2.4.22/include/linux/mm.h#L44
[address_space_operations]:https://github.com/lorenzo-stoakes/linux-historical/blob/v2.4.22/include/linux/fs.h#L385
[read]:http://man7.org/linux/man-pages/man2/read.2.html
[write]:http://man7.org/linux/man-pages/man2/write.2.html
[file_operations]:https://github.com/lorenzo-stoakes/linux-historical/blob/v2.4.22/include/linux/fs.h#L858
[shmem_inodes]:https://github.com/lorenzo-stoakes/linux-historical/blob/v2.4.22/mm/shmem.c#L71
[kern_mount]:https://github.com/lorenzo-stoakes/linux-historical/blob/v2.4.22/fs/super.c#L866
[ipc]:https://en.wikipedia.org/wiki/Inter-process_communication
